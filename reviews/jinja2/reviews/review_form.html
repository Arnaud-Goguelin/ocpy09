{% extends 'base.html' %}

{% from 'macros/form_macros.html' import render_field %}
{% from 'macros/button_macros.html' import action_buttons %}

{% block title %}
    {% if review %}Update{% else %}Create{% endif %} a review - LitReview
{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{{ static('styles/components/button.css') }}">
    <link rel="stylesheet" href="{{ static('styles/components/form.css') }}">
    <link rel="stylesheet" href="{{ static('styles/components/star_rating.css') }}">
{% endblock %}

{% block content %}
<section class="flex --column --align-start">
    <h2 class="headline-xl mb-lg">
        {% if review %}Update{% else %}Create{% endif %} a review
    </h2>

    {% if ticket %}
        <div class="ticket-reference mb-lg">
            <h3>You are responding to</h3>
            <div class="ticket-info">
                <h4>{{ ticket.title }}</h4>
                {% if ticket.content %}
                    <p>{{ ticket.content }}</p>
                {% endif %}
                {% if ticket.image %}
                    <img src="{{ ticket.image.url }}" alt="{{ ticket.title }}" style="max-width: 200px;">
                {% endif %}
            </div>
        </div>
    {% endif %}

    <form class="form-global width-100" method="post" enctype="multipart/form-data">

<!--        title field-->
        {{ render_field(form.title, css_class="form-input") }}

<!--        rating field -->
        {{ star_rating_field(form.rating) }}

<!--        content field-->
        {{ render_field(form.content, css_class="from-text-area", rows=6) }}


<!--        error displaying in form-->
        {% if form.non_field_errors() %}
            <div class="bold error-text mt-sm">
                {% for error in form.non_field_errors() %}
                    <div>{{ error }}</div>
                {% endfor %}
            </div>
        {% endif %}

<!--        actions buttons-->
        {{ action_buttons(
            primary_text=("Update" if review else "Send"),
            cancel_url=url('review:list'),
            cancel_text="Cancel"
        ) }}
    </form>
</section>

<script>
<!--    wait for complete DOM loading-->
document.addEventListener('DOMContentLoaded', function() {
    const interactiveRatings = document.querySelectorAll('.star-rating-interactive');

    interactiveRatings.forEach(function(rating) {
        const stars = rating.querySelectorAll('.star-clickable');
        const hiddenInput = rating.querySelector('input[type="hidden"]');
        const ratingText = rating.querySelector('.rating-text');

        stars.forEach(function(star) {
            star.addEventListener('click', function() {
                const newRating = parseInt(this.dataset.value);
                hiddenInput.value = newRating;

                stars.forEach(function(s, index) {
                    if (index < newRating) {
                        s.classList.remove('star-empty');
                        s.classList.add('star-filled');
                    } else {
                        s.classList.remove('star-filled');
                        s.classList.add('star-empty');
                    }
                });

                ratingText.textContent = newRating + '/5';
            });
        });
    });
});
</script>
{% endblock %}
